{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Portefeuille du Club üöÄ - LSM Investment Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{% static 'logo-lsmic.ico' %}" type="image/x-icon">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <div class="header-left">
            <img src="{% static 'logo-lsmic.png' %}" alt="Logo LSMIC">
            <a href="{% url 'home' %}">LSM Investment Club</a>
        </div>
        <div class="header-right">
            <a href="#">Actualit√©s</a>
            <a href="/portfolio/">Portefeuille</a>
            <a href="/performance/">Performance</a>
            {% if user.is_authenticated %}
                <a href="/profile/">{{ user.username }}</a>
            {% else %}
                <a href="/login/">Login</a>
            {% endif %}
        </div>
    </header>

    <main>
        <h1 class="portfolio-title">Portefeuille du Club</h1>

        <div class="charts-container">
            <div class="chart-card">
                <h3>R√©partition (valeur)</h3>
                <canvas id="donutChart"></canvas>
            </div>

            <div class="chart-card">
                <h3>ROI (%) par position</h3>
                <canvas id="barChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Prix d'achat vs Prix actuel</h3>
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <table class="summary-table">
            <thead>
                <tr>
                    <th>Montant Total Investi</th>
                    <th>Valeur Actuelle Totale</th>
                    <th>ROI ‚Ç¨ Total</th>
                    <th>ROI % Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ portfolio_total_invested|floatformat:2 }} ‚Ç¨</td>
                    <td>{{ portfolio_total_value|floatformat:2 }} ‚Ç¨</td>
                    
                    <td>
                        {% if portfolio_roi_value >= 0 %}
                            <span style="color: green;">+{{ portfolio_roi_value|floatformat:2 }} ‚Ç¨</span>
                        {% else %}
                            <span style="color: red;">{{ portfolio_roi_value|floatformat:2 }} ‚Ç¨</span>
                        {% endif %}
                    </td>

                    <td>
                        {% if portfolio_roi_percent >= 0 %}
                            <span style="color: green;">+{{ portfolio_roi_percent|floatformat:2 }} %</span>
                        {% else %}
                            <span style="color: red;">{{ portfolio_roi_percent|floatformat:2 }} %</span>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
        
        <table>
            <tr>
                <th>Logo</th>
                <th>Ticker</th>
                <th>Parts</th>
                <th>Prix d'achat</th>
                <th>Prix actuel</th>
                <th>Valeur totale</th>
                <th>ROI ‚Ç¨</th>
                <th>ROI %</th>
            </tr>
            {% for p in data %}
            <tr>
                <td>
                    {% if p.logo %}
                        <img src="{{ p.logo.url }}" alt="{{ p.ticker }}" width="40" style="vertical-align: middle; margin-right: 8px;">
                    {% endif %}
                </td>
                <td title="{{ p.company_name }}">{{ p.ticker }}</td>
                <td>{{ p.shares }}</td>
                <td>{% if p.purchase_price %}{{ p.purchase_price }}{% else %}-{% endif %}</td>
                <td>{% if p.current_price %}{{ p.current_price }}{% else %}-{% endif %}</td>
                <td>{% if p.total_value %}{{ p.total_value|floatformat:2 }}{% else %}-{% endif %}</td>
                <td>
                    {% if p.roi_value %}
                        {% if p.roi_value >= 0 %}
                            <span style="color: green;">{{ p.roi_value|floatformat:2 }}</span>
                        {% else %}
                            <span style="color: red;">{{ p.roi_value|floatformat:2 }}</span>
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if p.roi_percent %}
                        {% if p.roi_percent >= 0 %}
                            <span style="color: green;">{{ p.roi_percent|floatformat:2 }}%</span>
                        {% else %}
                            <span style="color: red;">{{ p.roi_percent|floatformat:2 }}%</span>
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
            <footer>
        LSM Investment Club 2025 ¬©. Tous droits r√©serv√©s.
    </footer>
    {# JSON data injection - utilisez json_script et parsez c√¥t√© JS #}
    {{ tickers|json_script:"tickers" }}
    {{ values|json_script:"values" }}
    {{ roipercents|json_script:"roipercents" }}
    {{ purchase_prices|json_script:"purchase_prices" }}
    {{ current_prices|json_script:"current_prices" }}
    </main>
</body>
<script>
// Fonction pour trier le tableau
function sortTable(n) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.querySelector("table");
    switching = true;
    dir = "asc"; // ordre initial croissant

    while (switching) {
        switching = false;
        rows = table.rows;

        for (i = 1; i < (rows.length - 1); i++) { // commencer apr√®s l'en-t√™te
            shouldSwitch = false;
            x = rows[i].getElementsByTagName("TD")[n];
            y = rows[i + 1].getElementsByTagName("TD")[n];

            // V√©rifie si les valeurs sont num√©riques ou non
            var xContent = parseFloat(x.textContent.replace(/[^0-9.-]+/g,"")) || x.textContent.toLowerCase();
            var yContent = parseFloat(y.textContent.replace(/[^0-9.-]+/g,"")) || y.textContent.toLowerCase();

            if (dir == "asc") {
                if (xContent > yContent) {
                    shouldSwitch = true;
                    break;
                }
            } else if (dir == "desc") {
                if (xContent < yContent) {
                    shouldSwitch = true;
                    break;
                }
            }
        }

        if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
        } else {
            if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
            }
        }
    }
}

// Ajoute l'√©couteur de clic sur tous les th
document.querySelectorAll("th").forEach((th, idx) => {
    th.style.cursor = "pointer"; // montre que c'est cliquable
    th.addEventListener("click", () => sortTable(idx));
});

// R√©cup√©rer les donn√©es JSON correctement
const tickers = JSON.parse(document.getElementById('tickers').textContent);
const values = JSON.parse(document.getElementById('values').textContent);
const roiPercents = JSON.parse(document.getElementById('roipercents').textContent);

// Donut chart (allocation)
const donutCtx = document.getElementById('donutChart').getContext('2d');
const donutChart = new Chart(donutCtx, {
    type: 'doughnut',
    data: {
        labels: tickers,
        datasets: [{
            data: values,
            borderWidth: 0.5
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio:false,
        plugins: {
            legend: { position: 'bottom' }
        },
        layout: {
            padding: { bottom: 20 }
        }
    }
});

const barColors = roiPercents.map(v => v >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)');
const barCtx = document.getElementById('barChart').getContext('2d');
const barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
        labels: tickers,
        datasets: [{
            label: 'ROI %',
            data: roiPercents,
            borderWidth: 1,
            backgroundColor: barColors,  // <- couleur selon valeur
            borderColor: barColors.map(c => c.replace('0.7','1')), // bordure plus fonc√©e
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio:false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: { callback: function(v){ return v + '%'; } }
            }
        },
        plugins: {
            legend: { display: false }
        },
        layout: { padding: { bottom: 20 } }
    }
});


const purchasePrices = JSON.parse(document.getElementById('purchase_prices').textContent);
const currentPrices = JSON.parse(document.getElementById('current_prices').textContent);

const lineCtx = document.getElementById('lineChart').getContext('2d');
new Chart(lineCtx, {
    type: 'line',
    data: {
        labels: tickers,
        datasets: [
            {
                label: "Prix d'achat",
                data: purchasePrices,
                borderColor: 'rgba(239, 68, 68, 1)', // rouge pour prix d'achat
                backgroundColor: 'rgba(239, 68, 68, 0.2)', // zone remplie semi-transparente
                borderWidth: 2,
                tension: 0.3,
                fill:true,
            },
            {
                label: "Prix actuel",
                borderColor: 'rgba(37, 99, 235, 1)',      // bleu fonc√© pour la ligne
                backgroundColor: 'rgba(37, 99, 235, 0.2)', // zone remplie semi-transparente
                data: currentPrices,
                borderWidth: 2,
                tension: 0.3,
                fill:true,
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        },
        scales: {
            y: { beginAtZero: false }
        }
    }
});

</script>
</html>